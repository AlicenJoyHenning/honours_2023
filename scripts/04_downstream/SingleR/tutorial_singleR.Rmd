---
title: "SingleR_tutorial"
output: html_notebook
---



```{r}
# Installing the packages, install.packages() not working : 

if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("TENxPBMCData")
BiocManager::install("celldex")
BiocManager::install("SingleR")
BiocManager::install("scRNAseq")
BiocManager::install("DimPlot")
BiocManager::install(c("Biobase", "SummarizedExperiment"))

# load the package into the R environment :  

library(TENxPBMCData) 
library(celldex)
library(SingleR)
library(scRNAseq)

library(Biobase)
library(SummarizedExperiment)

# Create objects with the values of the datasets :

new.data <- TENxPBMCData("pbmc4") # using the function TENxPBMCData from the TENxPBMCData package to load a specific dataset
ref.data <- HumanPrimaryCellAtlasData(ensembl=TRUE) # using the celldex package 

immgen <- ImmGenData(ensembl=TRUE) # using the celldex package 

HSC.data <- GrunHSCData(ensembl=TRUE) # referencing a specific data set (HSC and pancreatic)



# investigate the data sets themselves : 

HSC.data # viewing the data set 
head(HSC.data$label.fine)
View(as.data.frame(colData(HSC.data))) # shows us the cell types within the reference as a data frame 


immgen
head(immgen$label.fine)
View(as.data.frame(colData(immgen))) 
# output of view : three labels (label main : major subtype, label fine: high granularity, longer time to annotate test data, label ontology : standard vocab mapped to annotations)


# Using SingleR to perform annotations on the test datasets using the reference datasets (makes predictions for the data) :

# counts <- GetAssayData(new.data, slot = 'counts') # creates count matric for data set to enter as input to singleR. This uses a function from Bioconductor's Summarized Experiment Objects, unnecessary for test data sets?


test.predictions <- SingleR(test = new.data,
                            assay.type.test=1,
                            ref = ref.data,
                            labels = ref.data$label.main)

predictions <- SingleR(test=new.data, assay.type.test=1, ref=ref.data, labels=ref.data$label.fine)

HSC.predictions <- SingleR(test=HSC.data, assay.type.test=1, ref= immgen, labels=ref.data$label.fine)


# create a table to display the results : 

table(predictions$labels)
head(sort(table(HSC.predictions$labels), decreasing = TRUE)) # shows list of cell types starting from the most commonly identified cell types to the least 

# some quality control on the HSC data set to only include sorted HSGs and remove low quality batch, the distribution of cell labels improves to what may be expected :

HSC.qc.predictions <- pred$labels[sce$protocol=="sorted hematopoietic stem cells" & sce$sample!="JC4"]
head(sort(table(HSC.predictions$labels), decreasing = TRUE))

# looking at the output : 
# SingleR output : row names are cell barcodes(default), main labels , tuning scores and label corresponding to first tuning score, prune.labels : removes labels based on low quality scores
# now we can use these labels to visualise the data in a UMAP plot

new.data$singleR.labels <- test.predictions$labels[match(rownames(new.data@metadata), rownames(test.predictions))] # match cell barcodes with output SingleR

library(Seurat)
DimPlot(new.data, reduction = 'umap', group.by = 'SingleR.labels')





```

